<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
        }

        .score-human {
            background: #d1fae5;
            color: #065f46;
        }

        .score-suspicious {
            background: #fef3c7;
            color: #92400e;
        }

        .score-bot {
            background: #fee2e2;
            color: #991b1b;
        }

        .cluster-tag {
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 4px;
            background: #e0e7ff;
            color: #3730a3;
            cursor: pointer;
            transition: background 0.15s;
        }

        .cluster-tag:hover {
            background: #c7d2fe;
        }

        .suspicion-high {
            border-left: 4px solid #ef4444;
        }

        .suspicion-medium {
            border-left: 4px solid #f59e0b;
        }

        .suspicion-low {
            border-left: 4px solid #3b82f6;
        }

        .suspicion-none {
            border-left: 4px solid #6b7280;
        }

        .confidence-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .conf-high {
            background: #10b981;
        }

        .conf-medium {
            background: #f59e0b;
        }

        .conf-low {
            background: #ef4444;
        }

        .tab-btn {
            padding: 8px 20px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            color: #64748b;
            transition: all 0.2s;
            cursor: pointer;
        }

        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #1e293b;
        }

        .tab-btn:hover:not(.active) {
            color: #334155;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            backdrop-filter: blur(8px);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        tr {
            transition: background 0.15s;
        }

        #map {
            height: 400px;
            z-index: 1;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">

        <!-- â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div
            class="glass-card p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="text-3xl">ğŸ“¡</span> Pixel Analytics
                </h1>
                <p class="text-sm text-gray-500 mt-1">Bot Detection Â· Cluster Analysis Â· Geolocation</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="loadData()"
                    class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium shadow-sm">
                    â†» Refresh
                </button>
                <div class="text-sm text-gray-500 text-right leading-relaxed">
                    <div id="lastUpdated">Updated: Never</div>
                    <div id="totalVisits">Total Visits: 0</div>
                </div>
            </div>
        </div>

        <!-- â”€â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="stat-card p-4 rounded-xl shadow-sm text-center">
                <div id="statTotal" class="text-3xl font-bold text-gray-800">0</div>
                <div class="text-xs text-gray-500 mt-1 font-medium">Total Visits</div>
            </div>
            <div class="stat-card p-4 rounded-xl shadow-sm text-center">
                <div id="statHuman" class="text-3xl font-bold text-green-600">0</div>
                <div class="text-xs text-gray-500 mt-1 font-medium">Human</div>
            </div>
            <div class="stat-card p-4 rounded-xl shadow-sm text-center">
                <div id="statSuspicious" class="text-3xl font-bold text-amber-500">0</div>
                <div class="text-xs text-gray-500 mt-1 font-medium">Suspicious</div>
            </div>
            <div class="stat-card p-4 rounded-xl shadow-sm text-center">
                <div id="statBot" class="text-3xl font-bold text-red-600">0</div>
                <div class="text-xs text-gray-500 mt-1 font-medium">Bot</div>
            </div>
            <div class="stat-card p-4 rounded-xl shadow-sm text-center">
                <div id="statClusters" class="text-3xl font-bold text-indigo-600">0</div>
                <div class="text-xs text-gray-500 mt-1 font-medium">Clusters</div>
            </div>
        </div>

        <!-- â”€â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="glass-card p-5 rounded-xl shadow-sm">
            <h2 class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wider">Filters</h2>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                <input type="text" id="filterSource" placeholder="Source"
                    class="border border-gray-200 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none"
                    onkeyup="refreshView()">
                <input type="text" id="filterIP" placeholder="IP Address"
                    class="border border-gray-200 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none"
                    onkeyup="refreshView()">
                <input type="text" id="filterPlatform" placeholder="Platform/OS"
                    class="border border-gray-200 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none"
                    onkeyup="refreshView()">
                <select id="filterTime"
                    class="border border-gray-200 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-200 outline-none"
                    onchange="refreshView()">
                    <option value="all">All Time</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
                <select id="filterClassification"
                    class="border border-gray-200 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-200 outline-none"
                    onchange="refreshView()">
                    <option value="all">All Classifications</option>
                    <option value="human">âœ… Human</option>
                    <option value="suspicious">âš ï¸ Suspicious</option>
                    <option value="bot">ğŸ¤– Bot</option>
                </select>
                <input type="text" id="filterCountry" placeholder="Country"
                    class="border border-gray-200 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none"
                    onkeyup="refreshView()">
            </div>
        </div>

        <!-- Map -->
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="font-semibold mb-4">Visitor Map (Approximate Location via IP)</h3>
            <div id="map" class="rounded border"></div>
            <p class="text-xs text-gray-400 mt-2">Note: Locations are approximate based on Cloudflare/IP data. Only
                displays visitors with Country info.</p>
        </div>

        <!-- â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="glass-card rounded-xl shadow-sm overflow-hidden">
            <div class="flex border-b border-gray-200 bg-white/80 px-4">
                <button class="tab-btn active" onclick="switchTab('visitors', this)">Visitors</button>
                <button class="tab-btn" onclick="switchTab('clusters', this)">Clusters</button>
                <button class="tab-btn" onclick="switchTab('charts', this)">Charts</button>
            </div>

            <!-- Tab: Visitors -->
            <div id="tabVisitors" class="tab-content">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50/80 text-gray-500 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="p-4 border-b font-semibold">Time</th>
                                <th class="p-4 border-b font-semibold">Source</th>
                                <th class="p-4 border-b font-semibold">Bot Score</th>
                                <th class="p-4 border-b font-semibold">Location</th>
                                <th class="p-4 border-b font-semibold">Device</th>
                                <th class="p-4 border-b font-semibold">Cluster</th>
                                <th class="p-4 border-b font-semibold">Details</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm text-gray-700 divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <div id="noData" class="p-8 text-center text-gray-400 hidden">No data found matching filters.</div>
            </div>

            <!-- Tab: Clusters -->
            <div id="tabClusters" class="tab-content hidden p-6">
                <div id="clusterContent" class="space-y-3"></div>
                <div id="noClusters" class="p-8 text-center text-gray-400 hidden">No clusters detected yet.</div>
            </div>

            <!-- Tab: Charts -->
            <div id="tabCharts" class="tab-content hidden p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white/60 p-5 rounded-lg">
                        <h3 class="font-semibold mb-4 text-center text-gray-600 text-sm">Visits Over Time (7 Days)</h3>
                        <canvas id="chartHistory"></canvas>
                    </div>
                    <div class="bg-white/60 p-5 rounded-lg">
                        <h3 class="font-semibold mb-4 text-center text-gray-600 text-sm">Bot Classification</h3>
                        <canvas id="chartBotDist"></canvas>
                    </div>
                    <div class="bg-white/60 p-5 rounded-lg">
                        <h3 class="font-semibold mb-4 text-center text-gray-600 text-sm">Devices</h3>
                        <canvas id="chartDevices"></canvas>
                    </div>
                    <div class="bg-white/60 p-5 rounded-lg">
                        <h3 class="font-semibold mb-4 text-center text-gray-600 text-sm">Top Countries</h3>
                        <canvas id="chartCountries"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="modal" class="modal-backdrop fixed inset-0 hidden flex items-center justify-center z-50"
        onclick="closeModal(event)">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-800" id="modalTitle">Event Details</h3>
                <button onclick="document.getElementById('modal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <pre id="modalContent"
                class="bg-gray-50 p-4 rounded-lg text-xs font-mono overflow-x-auto border border-gray-200"></pre>
        </div>
    </div>

    <script>
        let rawData = [];
        let clusterData = [];
        let charts = {};
        let map = null;
        let markers = [];

        const DATA_URL = 'src/php/visits.json';
        const CLUSTER_URL = 'src/php/clusters.json';

        // â”€â”€ Init Leaflet Map â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            map = L.map('map').setView([30, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 18,
            }).addTo(map);
        });

        function getDeviceType(row) {
            const ua = (row.userAgent || '').toLowerCase();
            if (ua.includes('iphone') || ua.includes('fban')) return 'ğŸ“± iPhone';
            if (ua.includes('android')) return 'ğŸ“± Android';
            if (ua.includes('macintosh')) return 'ğŸ–¥ï¸ Mac';
            if (ua.includes('windows')) return 'ğŸ–¥ï¸ Windows';
            if (ua.includes('bot') || ua.includes('crawl')) return 'ğŸ¤– Bot';
            return 'ğŸ–¥ï¸ Desktop';
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Tab Switching                                                 */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            btn.classList.add('active');
            if (tab === 'charts') updateCharts(filterData());
            if (tab === 'clusters') renderClusters();
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Load Data                                                     */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        async function loadData() {
            try {
                const [visitRes, clusterRes] = await Promise.allSettled([
                    fetch(DATA_URL),
                    fetch(CLUSTER_URL),
                ]);

                // Parse visits
                if (visitRes.status === 'fulfilled' && visitRes.value.ok) {
                    const text = await visitRes.value.text();
                    const jsonStr = '[' + text.replace(/}\s*\{/g, '},{') + ']';
                    rawData = JSON.parse(jsonStr);
                    rawData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }

                // Parse clusters
                if (clusterRes.status === 'fulfilled' && clusterRes.value.ok) {
                    const cj = await clusterRes.value.json();
                    clusterData = cj.clusters || [];
                }

                document.getElementById('lastUpdated').innerText = 'Updated: ' + moment().format('HH:mm:ss');
                document.getElementById('totalVisits').innerText = 'Total Visits: ' + rawData.length;

                updateStats();
                refreshView();

            } catch (e) {
                console.error(e);
                alert('Error loading data: ' + e.message);
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Stats                                                         */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function updateStats() {
            let human = 0, suspicious = 0, bot = 0;
            rawData.forEach(r => {
                const cls = r.botClassification || classify(r.botScore);
                if (cls === 'human') human++;
                else if (cls === 'suspicious') suspicious++;
                else bot++;
            });

            document.getElementById('statTotal').textContent = rawData.length;
            document.getElementById('statHuman').textContent = human;
            document.getElementById('statSuspicious').textContent = suspicious;
            document.getElementById('statBot').textContent = bot;
            document.getElementById('statClusters').textContent = clusterData.length;
        }

        function classify(score) {
            if (score == null) return 'unknown';
            if (score >= 70) return 'human';
            if (score >= 30) return 'suspicious';
            return 'bot';
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Filter                                                        */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function filterData() {
            const sQ = document.getElementById('filterSource').value.toLowerCase();
            const ipQ = document.getElementById('filterIP').value.toLowerCase();
            const pQ = document.getElementById('filterPlatform').value.toLowerCase();
            const tQ = document.getElementById('filterTime').value;
            const cQ = document.getElementById('filterClassification').value;
            const coQ = document.getElementById('filterCountry').value.toLowerCase();
            const now = moment();

            return rawData.filter(row => {
                const q = row.query || {};
                const source = (q.source || 'web').toLowerCase();
                const ip = (row.ip || '').toLowerCase();
                const platform = (q.platform || row.userAgent || '').toLowerCase();
                const ts = moment(row.timestamp);
                const cls = row.botClassification || classify(row.botScore);

                // Location
                const loc = row.location || {};
                const country = (loc.country || loc.countryCode || '').toLowerCase();

                if (sQ && !source.includes(sQ)) return false;
                if (ipQ && !ip.includes(ipQ)) return false;
                if (pQ && !platform.includes(pQ)) return false;
                if (cQ !== 'all' && cls !== cQ) return false;
                if (coQ && !country.includes(coQ)) return false;

                if (tQ === '24h' && now.diff(ts, 'hours') > 24) return false;
                if (tQ === '7d' && now.diff(ts, 'days') > 7) return false;
                if (tQ === '30d' && now.diff(ts, 'days') > 30) return false;

                return true;
            });
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Orchestrator â€” called on load and filter changes              */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function refreshView() {
            const filtered = filterData();
            renderTable(filtered);
            updateCharts(filtered);
            updateMap(filtered);
        }

        function updateMap(data) {
            if (!map) return;

            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Country-center fallback coords (used when ipapi lat/lon is missing)
            const countryCoords = {
                'US': [37.09, -95.71], 'CA': [56.13, -106.35], 'GB': [55.38, -3.44],
                'DE': [51.17, 10.45], 'FR': [46.23, 2.21], 'IN': [20.59, 78.96],
                'CN': [35.86, 104.20], 'AU': [-25.27, 133.78], 'BR': [-14.24, -51.93],
                'JP': [36.20, 138.25], 'KR': [35.91, 127.77], 'MX': [23.63, -102.55],
                'ES': [40.46, -3.75], 'IT': [41.87, 12.57], 'NL': [52.13, 5.29],
                'RU': [61.52, 105.32], 'ZA': [-30.56, 22.94], 'NG': [9.08, 8.68],
                'SG': [1.35, 103.82], 'AE': [23.42, 53.85],
            };

            // Pick bot-score-based color
            const scoreColor = (row) => {
                const cls = row.botClassification || classify(row.botScore);
                if (cls === 'human') return '#10b981';
                if (cls === 'suspicious') return '#f59e0b';
                return '#ef4444';
            };

            data.forEach(row => {
                const loc = row.location || {};
                let lat = loc.latitude;
                let lon = loc.longitude;

                // Fallback: use country-center coords with jitter
                if (lat == null || lon == null) {
                    const cc = (loc.countryCode || row.headers?.['cf-ipcountry'] || '').toUpperCase();
                    const center = countryCoords[cc];
                    if (!center) return;
                    lat = center[0] + (Math.random() - 0.5) * 5;
                    lon = center[1] + (Math.random() - 0.5) * 10;
                }

                const marker = L.circleMarker([lat, lon], {
                    radius: 5,
                    fillColor: scoreColor(row),
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8,
                }).addTo(map);

                const cls = row.botClassification || classify(row.botScore);
                const score = row.botScore != null ? row.botScore : '?';
                marker.bindPopup(
                    `<b>${row.ip || 'Unknown'}</b><br>` +
                    `${loc.city ? loc.city + ', ' : ''}${loc.country || loc.countryCode || '??'}<br>` +
                    `Score: ${score} (${cls})<br>` +
                    `${moment(row.timestamp).fromNow()} Â· ${getDeviceType(row)}`
                );
                markers.push(marker);
            });
        }

        function renderTable(filtered) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            document.getElementById('noData').classList.toggle('hidden', filtered.length > 0);

            filtered.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50/40 transition';

                const q = row.query || {};
                const loc = row.location || {};
                const cls = row.botClassification || classify(row.botScore);
                const score = row.botScore != null ? row.botScore : '?';

                // Source badge
                let srcBadge = 'bg-gray-100 text-gray-600';
                let srcText = q.source || 'web';
                if (srcText.includes('resume')) srcBadge = 'bg-purple-100 text-purple-700';

                // Bot score badge
                let scoreBadge = 'score-bot';
                let scoreIcon = 'ğŸ¤–';
                if (cls === 'human') { scoreBadge = 'score-human'; scoreIcon = 'âœ…'; }
                else if (cls === 'suspicious') { scoreBadge = 'score-suspicious'; scoreIcon = 'âš ï¸'; }

                // Location
                const city = loc.city || '';
                const region = loc.region || '';
                const country = loc.country || loc.countryCode || '??';
                const conf = loc.confidence || 0;
                let confClass = 'conf-low';
                if (conf >= 0.7) confClass = 'conf-high';
                else if (conf >= 0.4) confClass = 'conf-medium';
                const locParts = [city, region, country].filter(Boolean);
                const locStr = locParts.join(', ') || 'Unknown';
                const locSrc = loc.source || '';

                // Device
                const isMobile = (row.userAgent || '').includes('Mobile');
                const osLabel = q.platform || ((row.userAgent || '').match(/\(([^)]+)\)/)?.[1] || 'Unknown');

                // Cluster
                const clusterKey = row.clusterKey || '';

                tr.innerHTML = `
                    <td class="p-4 border-b">
                        <div class="font-medium text-gray-800">${moment(row.timestamp).format('MMM D, HH:mm')}</div>
                        <div class="text-xs text-gray-400">${moment(row.timestamp).fromNow()}</div>
                    </td>
                    <td class="p-4 border-b">
                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold ${srcBadge}">${srcText}</span>
                    </td>
                    <td class="p-4 border-b">
                        <span class="score-badge ${scoreBadge}">${scoreIcon} ${score}</span>
                    </td>
                    <td class="p-4 border-b">
                        <div class="flex items-center">
                            <span class="confidence-dot ${confClass}" title="Confidence: ${(conf * 100).toFixed(0)}% (${locSrc})"></span>
                            <span class="text-sm">${locStr}</span>
                        </div>
                        <div class="text-xs text-gray-400 font-mono">${row.ip || ''}</div>
                    </td>
                    <td class="p-4 border-b">
                        <div class="text-sm truncate max-w-[180px]" title="${osLabel}">${osLabel}</div>
                        <div class="text-xs text-gray-400">${isMobile ? 'ğŸ“± Mobile' : 'ğŸ–¥ï¸ Desktop'}</div>
                    </td>
                    <td class="p-4 border-b">
                        ${clusterKey
                        ? `<span class="cluster-tag" onclick="filterByCluster('${clusterKey}')" title="Click to filter">${clusterKey}</span>`
                        : '<span class="text-xs text-gray-300">â€”</span>'}
                    </td>
                    <td class="p-4 border-b">
                        <button onclick='showJson(${JSON.stringify(row).replace(/'/g, "&#39;")})'
                            class="text-blue-500 hover:text-blue-700 text-sm font-medium transition">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterByCluster(key) {
            document.getElementById('filterIP').value = '';
            document.getElementById('filterSource').value = '';
            // Filter table to show only matching cluster
            renderTableFiltered(row => (row.clusterKey || '') === key);
        }

        function renderTableFiltered(predicate) {
            const filtered = rawData.filter(predicate);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            document.getElementById('noData').classList.toggle('hidden', filtered.length > 0);

            filtered.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50/40 transition bg-indigo-50/30';
                const q = row.query || {};
                const loc = row.location || {};
                const cls = row.botClassification || classify(row.botScore);
                const score = row.botScore != null ? row.botScore : '?';

                let scoreBadge = 'score-bot', scoreIcon = 'ğŸ¤–';
                if (cls === 'human') { scoreBadge = 'score-human'; scoreIcon = 'âœ…'; }
                else if (cls === 'suspicious') { scoreBadge = 'score-suspicious'; scoreIcon = 'âš ï¸'; }

                const locParts = [loc.city, loc.region, loc.country || loc.countryCode].filter(Boolean);
                const locStr = locParts.join(', ') || 'Unknown';

                tr.innerHTML = `
                    <td class="p-4 border-b font-medium">${moment(row.timestamp).format('MMM D, HH:mm')}</td>
                    <td class="p-4 border-b"><span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-100">${q.source || 'web'}</span></td>
                    <td class="p-4 border-b"><span class="score-badge ${scoreBadge}">${scoreIcon} ${score}</span></td>
                    <td class="p-4 border-b">${locStr}<div class="text-xs text-gray-400 font-mono">${row.ip || ''}</div></td>
                    <td class="p-4 border-b text-sm">${q.platform || 'Unknown'}</td>
                    <td class="p-4 border-b"><span class="cluster-tag">${row.clusterKey || 'â€”'}</span></td>
                    <td class="p-4 border-b">
                        <button onclick='showJson(${JSON.stringify(row).replace(/'/g, "&#39;")})' class="text-blue-500 hover:text-blue-700 text-sm font-medium">View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Render: Clusters                                              */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function renderClusters() {
            const content = document.getElementById('clusterContent');
            content.innerHTML = '';

            if (!clusterData || clusterData.length === 0) {
                document.getElementById('noClusters').classList.remove('hidden');
                return;
            }
            document.getElementById('noClusters').classList.add('hidden');

            // Sort: highest visit count first
            const sorted = [...clusterData].sort((a, b) => b.visitCount - a.visitCount);

            sorted.forEach(cl => {
                const susp = cl.suspicionLevel || 'none';
                const div = document.createElement('div');
                div.className = `bg-white/80 p-4 rounded-lg shadow-sm suspicion-${susp} cursor-pointer hover:shadow-md transition`;

                const fp = cl.fingerprint || {};
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="cluster-tag text-sm">${cl.id}</span>
                            <span class="ml-2 text-xs text-gray-500">
                                ${cl.visitCount} visit${cl.visitCount !== 1 ? 's' : ''} Â·
                                ${susp} suspicion
                            </span>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${cl.firstSeen ? moment(cl.firstSeen).format('MMM D') : '?'} â€” ${cl.lastSeen ? moment(cl.lastSeen).format('MMM D HH:mm') : '?'}
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 flex flex-wrap gap-4">
                        <span>Canvas: <code>${fp.canvasHash || 'â€”'}</code></span>
                        <span>GPU: <code>${(fp.gpuRenderer || 'â€”').substring(0, 35)}</code></span>
                        <span>IP Prefix: <code>${fp.ipPrefix || 'â€”'}</code></span>
                    </div>
                `;

                div.onclick = () => filterByCluster(cl.id);
                content.appendChild(div);
            });
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Charts                                                        */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function updateCharts(filtered) {
            if (!filtered) filtered = filterData();

            // â”€â”€ History Chart â”€â”€
            const days = {};
            for (let i = 6; i >= 0; i--) {
                days[moment().subtract(i, 'days').format('YYYY-MM-DD')] = 0;
            }
            filtered.forEach(row => {
                const d = moment(row.timestamp).format('YYYY-MM-DD');
                if (days[d] !== undefined) days[d]++;
            });

            if (charts.history) charts.history.destroy();
            charts.history = new Chart(document.getElementById('chartHistory'), {
                type: 'line',
                data: {
                    labels: Object.keys(days).map(d => moment(d).format('MMM D')),
                    datasets: [{
                        label: 'Visits',
                        data: Object.values(days),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.08)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // â”€â”€ Bot Classification Doughnut â”€â”€
            let hCount = 0, sCount = 0, bCount = 0;
            filtered.forEach(r => {
                const c = r.botClassification || classify(r.botScore);
                if (c === 'human') hCount++;
                else if (c === 'suspicious') sCount++;
                else bCount++;
            });

            if (charts.botDist) charts.botDist.destroy();
            charts.botDist = new Chart(document.getElementById('chartBotDist'), {
                type: 'doughnut',
                data: {
                    labels: ['Human', 'Suspicious', 'Bot'],
                    datasets: [{
                        data: [hCount, sCount, bCount],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0,
                    }]
                },
                options: { responsive: true, cutout: '60%' }
            });

            // â”€â”€ Devices â”€â”€
            const devCounts = {};
            filtered.forEach(row => {
                let cat = 'Desktop';
                const ua = (row.userAgent || '').toLowerCase();
                if (ua.includes('iphone') || ua.includes('fban')) cat = 'iPhone';
                else if (ua.includes('android')) cat = 'Android';
                else if (ua.includes('macintosh')) cat = 'Mac';
                else if (ua.includes('windows')) cat = 'Windows';
                else if (ua.includes('bot') || ua.includes('crawl')) cat = 'Bot';
                devCounts[cat] = (devCounts[cat] || 0) + 1;
            });

            if (charts.devices) charts.devices.destroy();
            charts.devices = new Chart(document.getElementById('chartDevices'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(devCounts),
                    datasets: [{
                        data: Object.values(devCounts),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280'],
                        borderWidth: 0,
                    }]
                },
                options: { responsive: true, cutout: '60%' }
            });

            // â”€â”€ Countries â”€â”€
            const countryCounts = {};
            filtered.forEach(row => {
                const loc = row.location || {};
                const c = loc.country || loc.countryCode || 'Unknown';
                countryCounts[c] = (countryCounts[c] || 0) + 1;
            });
            const topCountries = Object.entries(countryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            if (charts.countries) charts.countries.destroy();
            charts.countries = new Chart(document.getElementById('chartCountries'), {
                type: 'bar',
                data: {
                    labels: topCountries.map(c => c[0]),
                    datasets: [{
                        label: 'Visits',
                        data: topCountries.map(c => c[1]),
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                }
            });
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Modal                                                         */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function showJson(data) {
            // Pretty-print with score breakdown highlighted
            const title = data.botClassification
                ? `Event Details â€” ${data.botClassification.toUpperCase()} (Score: ${data.botScore})`
                : 'Event Details';
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').textContent = JSON.stringify(data, null, 2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal(e) {
            if (e.target.id === 'modal') {
                document.getElementById('modal').classList.add('hidden');
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /*  Init                                                          */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>